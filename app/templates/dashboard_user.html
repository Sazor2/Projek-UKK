{% extends "base.html" %}

{% block title %}Dashboard Siswa{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="welcome-text">Selamat Datang, {{ current_user.name }}</h2>
                <p class="text-muted">{{ "Silahkan lengkapi pendaftaran Anda" if not form_submitted else "Status pendaftaran Anda dapat dilihat di bawah" }}</p>
            </div>
            <div class="col-md-4 text-md-end">
                {% if form_status == 'accepted' %}
                    <div class="status-pill success">
                        <i class="fas fa-check-circle"></i> Diterima
                    </div>
                {% elif form_status == 'rejected' %}
                    <div class="status-pill danger">
                        <i class="fas fa-times-circle"></i> Tidak Diterima
                    </div>
                {% elif form_status == 'pending' %}
                    <div class="status-pill warning">
                        <i class="fas fa-clock"></i> Dalam Proses
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-md-4">
            <div class="card profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">
                        {% if form_submitted and form_submitted.foto_siswa %}
                            <img src="{{ url_for('static', filename='uploads/' + form_submitted.foto_siswa) }}" 
                                 alt="Foto 3x4">
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div class="profile-info-header">
                        <h5 class="profile-name">{{ current_user.name }}</h5>
                        {% if form_submitted %}
                            <span class="profile-id">NISN: {{ form_submitted.parsed_form_data.get('nisn') }}</span>
                        {% endif %}
                    </div>
                </div>

                {% if form_submitted %}
                    {% set form_data = form_submitted.parsed_form_data %}
                    <div class="profile-info">
                        <div class="info-item">
                            <i class="fas fa-venus-mars"></i>
                            <div>
                                <label>Jenis Kelamin</label>
                                <span>{{ "Laki-laki" if form_data.get('gender') == 'L' else "Perempuan" }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-graduation-cap"></i>
                            <div>
                                <label>Jurusan</label>
                                <span>{{ "IPA" if form_data.get('jurusan') == 'ipa' else "IPS" }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar"></i>
                            <div>
                                <label>Tanggal Lahir</label>
                                <span>{{ form_data.get('birth_date') }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <label>Telepon</label>
                                <span>{{ form_data.get('phone') }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-school"></i>
                            <div>
                                <label>Asal Sekolah</label>
                                <span>{{ form_data.get('previous_school') }}</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <label>Alamat</label>
                                <span>{{ form_data.get('address') }}</span>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            {% if form_submitted %}
            <!-- Tombol Hapus Akun -->
            <div class="mt-3">
                <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                    <i class="fas fa-trash-alt me-2"></i>Hapus Akun
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Right Column -->
        <div class="col-md-8">
            {% if not form_submitted %}
                <!-- Form Pendaftaran -->
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Formulir Pendaftaran</h4>
                        
                        <form method="POST" action="{{ url_for('main.submit_form') }}" enctype="multipart/form-data" id="admission-form">
                            {{ form.hidden_tag() }}
                            
                            <!-- Data Pribadi -->
                            <div class="mb-4">
                                <h5><i class="fas fa-user me-2"></i>Data Pribadi</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">NISN*</label>
                                        {{ form.nisn(class="form-control", placeholder="Masukkan NISN") }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Jenis Kelamin*</label>
                                        {{ form.gender(class="form-select") }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Tanggal Lahir*</label>
                                        <div class="input-group">
                                            {{ form.birth_date(class="form-control datepicker", placeholder="YYYY-MM-DD") }}
                                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Pilihan Jurusan*</label>
                                        {{ form.jurusan(class="form-select") }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Nomor Telepon*</label>
                                        {{ form.phone(class="form-control", placeholder="Contoh: 08xxxxxxxxxx") }}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Asal Sekolah*</label>
                                        {{ form.previous_school(class="form-control", placeholder="Nama SMP/MTs") }}
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Alamat Lengkap*</label>
                                        {{ form.address(class="form-control", rows="3", placeholder="Masukkan alamat lengkap") }}
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Dokumen -->
                            <div class="mb-4">
                                <h5><i class="fas fa-file-upload me-2"></i>Upload Dokumen</h5>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">Pas Foto 3x4*</label>
                                            {{ form.foto_siswa(class="form-control") }}
                                            <small class="text-muted">Format: JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">Akta Kelahiran*</label>
                                            {{ form.akta_kelahiran(class="form-control") }}
                                            <small class="text-muted">Format: PDF, JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">Kartu Keluarga*</label>
                                            {{ form.kartu_keluarga(class="form-control") }}
                                            <small class="text-muted">Format: PDF, JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">Ijazah/SKL SMP*</label>
                                            {{ form.ijazah_smp(class="form-control") }}
                                            <small class="text-muted">Format: PDF, JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">KTP Orang Tua*</label>
                                            {{ form.ktp_ortu(class="form-control") }}
                                            <small class="text-muted">Format: PDF, JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">Nilai Rapor*</label>
                                            {{ form.nilai_rapor(class="form-control") }}
                                            <small class="text-muted">Format: PDF, JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="document-upload-box">
                                            <label class="form-label">Sertifikat Prestasi (Opsional)</label>
                                            {{ form.sertifikat_prestasi(class="form-control") }}
                                            <small class="text-muted">Format: PDF, JPG, PNG (Max 2MB)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>Kirim Pendaftaran
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <!-- Timeline Progress -->
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Progress Pendaftaran</h4>
                        
                        <div class="timeline">
                            <div class="timeline-item completed">
                                <div class="timeline-dot">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Pendaftaran</h5>
                                    <p>Form telah disubmit pada {{ form_submitted.timestamp.strftime('%d %B %Y') }}</p>
                                </div>
                            </div>

                            <div class="timeline-item {{ 'completed' if form_status in ['accepted', 'rejected'] else 'active' }}">
                                <div class="timeline-dot">
                                    {% if form_status in ['accepted', 'rejected'] %}
                                        <i class="fas fa-check"></i>
                                    {% else %}
                                        <i class="fas fa-spinner fa-spin"></i>
                                    {% endif %}
                                </div>
                                <div class="timeline-content">
                                    <h5>Verifikasi</h5>
                                    <p>{{ "Sedang dalam proses verifikasi" if form_status == 'pending' else "Verifikasi selesai" }}</p>
                                </div>
                            </div>

                            <div class="timeline-item {{ 'completed' if form_status == 'accepted' else 'active' if form_status == 'rejected' else '' }}">
                                <div class="timeline-dot">
                                    {% if form_status == 'accepted' %}
                                        <i class="fas fa-check"></i>
                                    {% elif form_status == 'rejected' %}
                                        <i class="fas fa-times"></i>
                                    {% else %}
                                        <i class="fas fa-clock"></i>
                                    {% endif %}
                                </div>
                                <div class="timeline-content">
                                    <h5>Hasil</h5>
                                    {% if form_status == 'accepted' %}
                                        <div class="result-box success">
                                            <i class="fas fa-check-circle"></i>
                                            <p>Selamat! Anda diterima sebagai siswa baru</p>
                                            <a href="#" class="btn btn-success btn-sm mt-2">
                                                <i class="fas fa-print me-2"></i>Cetak Bukti Penerimaan
                                            </a>
                                        </div>
                                    {% elif form_status == 'rejected' %}
                                        <div class="result-box danger">
                                            <i class="fas fa-times-circle"></i>
                                            <p>Maaf, Anda belum dapat diterima</p>
                                        </div>
                                    {% else %}
                                        <p>Menunggu hasil keputusan</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
{% if form_submitted %}
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Konfirmasi Hapus Akun</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Peringatan!</strong> Menghapus akun akan menghapus semua data pendaftaran Anda.
                    Tindakan ini tidak dapat dibatalkan.
                </div>
                <p>Apakah Anda yakin ingin menghapus akun?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <form action="{{ url_for('auth.delete_account') }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i>Hapus Akun
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}